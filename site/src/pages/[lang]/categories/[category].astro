---
import BaseLayout from "../../../layouts/BaseLayout.astro";
import ArticleCard from "../../../components/ArticleCard.astro";
import { isValidLang, type Language } from "../../../i18n/config";
import { t } from "../../../i18n/translations";
import { getAllCategories, getArticlesByCategory, getCategoryBySlug } from "../../../lib/db";

export function getStaticPaths() {
  const categories = getAllCategories();
  const paths = [];

  for (const category of categories) {
    for (const lang of ["fr", "en"]) {
      paths.push({
        params: { lang, category: category.url_slug },
      });
    }
  }

  return paths;
}

const { lang, category: categorySlug } = Astro.params;

if (!isValidLang(lang)) {
  return Astro.redirect("/fr", 302);
}

const category = getCategoryBySlug(categorySlug);
if (!category) {
  return Astro.redirect(`/${lang}`, 302);
}

const translations = t(lang as Language);
const articles = getArticlesByCategory(category.id, lang as Language);

const categoryTitle = lang === "fr" ? category.label_fr : category.label_en;
const categoryDescription =
  translations.categoryDescriptions[
    category.id as keyof typeof translations.categoryDescriptions
  ];

const alternateUrls = {
  fr: `/fr/categories/${categorySlug}`,
  en: `/en/categories/${categorySlug}`,
};
---

<BaseLayout
  title={categoryTitle}
  description={categoryDescription}
  lang={lang as Language}
  alternateUrls={alternateUrls}
>
  <!-- Header -->
  <section class="border-b border-stone-200 bg-cream-200 py-12">
    <div class="mx-auto max-w-4xl px-4 sm:px-6 lg:px-8">
      <nav class="mb-4 text-sm">
        <a href={`/${lang}`} class="text-stone-500 hover:text-stone-700">
          {translations.nav.home}
        </a>
        <span class="mx-2 text-stone-400">/</span>
        <a
          href={`/${lang}/categories`}
          class="text-stone-500 hover:text-stone-700"
        >
          {translations.nav.categories}
        </a>
        <span class="mx-2 text-stone-400">/</span>
        <span class="text-stone-900">{categoryTitle}</span>
      </nav>

      <h1 class="font-literata text-3xl font-bold tracking-tight text-stone-900">
        {categoryTitle}
      </h1>
      <p class="mt-2 text-lg text-stone-600">
        {categoryDescription}
      </p>
      <p class="mt-4 text-sm text-stone-500">
        {articles.length}{" "}
        {articles.length === 1 ? "article" : "articles"}
      </p>
    </div>
  </section>

  <!-- Articles List -->
  <section class="py-12 bg-white">
    <div class="mx-auto max-w-4xl px-4 sm:px-6 lg:px-8">
      {
        articles.length > 0 ? (
          <div class="grid gap-6 sm:grid-cols-2">
            {articles.map((article) => (
              <ArticleCard article={article} lang={lang as Language} />
            ))}
          </div>
        ) : (
          <div class="rounded-xl border border-stone-200 bg-white p-8 text-center">
            <p class="text-stone-500">
              {lang === "fr"
                ? "Aucun article dans cette catégorie pour l'instant."
                : "No articles in this category yet."}
            </p>
            <p class="mt-2 text-sm text-stone-400">
              {lang === "fr"
                ? "Les articles seront ajoutés après classification."
                : "Articles will be added after classification."}
            </p>
          </div>
        )
      }
    </div>
  </section>
</BaseLayout>
