---
export const prerender = false;

import AdminLayout from "../../../layouts/AdminLayout.astro";
import fs from "node:fs";
import path from "node:path";

// Check admin access
if (!import.meta.env.ENABLE_ADMIN) {
  return Astro.redirect("/");
}

const READY_DIR = "/Users/jd/Projects/pda/cache/articles/ready";

// Ensure directory exists
if (!fs.existsSync(READY_DIR)) {
  fs.mkdirSync(READY_DIR, { recursive: true });
}

// Get all _parsed.json files in ready directory
let jsonFiles: string[] = [];
try {
  const files = fs.readdirSync(READY_DIR);
  jsonFiles = files
    .filter((f) => f.endsWith("_parsed.json"))
    .sort((a, b) => a.localeCompare(b));
} catch (e) {
  console.error("Could not read ready directory:", e);
}

// For each file, read article info from the JSON
interface ReadyArticle {
  slug: string;
  title: string | null;
  authors: string | null;
  year: string | null;
  method: string | null;
  voice: string | null;
  peer_reviewed: boolean;
  doi: string | null;
  abstract_chars: number;
  body_chars: number;
}

const readyArticles: ReadyArticle[] = jsonFiles.map((filename) => {
  const filepath = path.join(READY_DIR, filename);
  const slug = filename.replace("_parsed.json", "");

  // Read article data from JSON
  let data: any = {};
  try {
    data = JSON.parse(fs.readFileSync(filepath, 'utf-8'));
  } catch (e) {
    console.error(`Could not parse ${filename}:`, e);
  }

  return {
    slug,
    title: data.title || null,
    authors: data.authors || null,
    year: data.year || null,
    method: data.method || null,
    voice: data.voice || null,
    peer_reviewed: !!data.peer_reviewed,
    doi: data.doi || null,
    abstract_chars: (data.abstract || '').length,
    body_chars: (data.body_html || '').length,
  };
});

// Summary stats
const totalReady = readyArticles.length;
---

<AdminLayout title="Review Articles">
  <div class="space-y-6">
    <!-- Page Header -->
    <div>
      <h1 class="text-2xl font-bold text-stone-900">Review Preprocessed Articles</h1>
      <p class="mt-1 text-sm text-stone-500">
        Articles that have completed preprocessing and are ready for human approval
      </p>
    </div>

    <!-- Stats -->
    <div class="flex gap-4">
      <div class="rounded-lg bg-white px-4 py-3 shadow-sm">
        <p class="text-sm text-stone-500">Ready for Review</p>
        <p class="text-2xl font-bold text-primary-600">{totalReady}</p>
      </div>
    </div>

    <!-- Instructions -->
    <div class="rounded-lg bg-primary-50 border border-primary-200 p-4">
      <h2 class="text-sm font-medium text-primary-800 mb-2">Review Workflow</h2>
      <ol class="text-sm text-primary-700 space-y-1 list-decimal list-inside">
        <li>Click an article to review its extracted content and Claude's classifications</li>
        <li>Set open_access (determines if full text can be translated)</li>
        <li>Optionally add source URL if DOI wasn't found</li>
        <li><strong>Approve</strong> to insert into database, or <strong>Reject</strong> to send back for rework</li>
      </ol>
    </div>

    <!-- Article List -->
    {readyArticles.length > 0 ? (
      <div class="rounded-lg bg-white shadow-sm overflow-hidden">
        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead>
              <tr class="border-b border-stone-200 bg-stone-50">
                <th class="px-4 py-3 text-left font-medium text-stone-500">Article</th>
                <th class="px-4 py-3 text-left font-medium text-stone-500">Year</th>
                <th class="px-4 py-3 text-left font-medium text-stone-500">Classification</th>
                <th class="px-4 py-3 text-left font-medium text-stone-500">Content</th>
                <th class="px-4 py-3 text-right font-medium text-stone-500">Actions</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-stone-100">
              {readyArticles.map((article) => (
                <tr class="hover:bg-stone-50">
                  <td class="px-4 py-3">
                    <div class="max-w-md">
                      <p class="font-medium text-stone-900 truncate" title={article.title || article.slug}>
                        {article.title || article.slug}
                      </p>
                      <p class="text-xs text-stone-500 truncate">
                        {article.authors || 'No authors'}
                      </p>
                    </div>
                  </td>
                  <td class="px-4 py-3 text-stone-500">
                    {article.year || '—'}
                  </td>
                  <td class="px-4 py-3">
                    <div class="flex flex-wrap gap-1">
                      {article.method && (
                        <span class="rounded bg-blue-100 text-blue-800 px-2 py-0.5 text-xs">
                          {article.method}
                        </span>
                      )}
                      {article.voice && (
                        <span class="rounded bg-purple-100 text-purple-800 px-2 py-0.5 text-xs">
                          {article.voice}
                        </span>
                      )}
                      {article.peer_reviewed && (
                        <span class="rounded bg-green-100 text-green-800 px-2 py-0.5 text-xs">
                          peer-reviewed
                        </span>
                      )}
                    </div>
                  </td>
                  <td class="px-4 py-3 text-stone-500 text-xs">
                    <span title="Abstract">{Math.round(article.abstract_chars / 100) / 10}k abs</span>
                    {' · '}
                    <span title="Body">{Math.round(article.body_chars / 1000)}k body</span>
                  </td>
                  <td class="px-4 py-3 text-right">
                    <a
                      href={`/admin/review/${article.slug}`}
                      class="text-primary-500 hover:text-primary-700 font-medium"
                    >
                      Review
                    </a>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </div>
    ) : (
      <div class="rounded-lg bg-white p-8 shadow-sm text-center">
        <h3 class="text-lg font-medium text-stone-900 mb-1">No Articles Ready</h3>
        <p class="text-sm text-stone-500">
          No preprocessed articles waiting for review. Run preprocessing via MCP tools first.
        </p>
      </div>
    )}

    <!-- File Paths -->
    <div class="rounded-lg bg-stone-50 border border-stone-200 p-4">
      <h3 class="text-sm font-medium text-stone-700 mb-2">File Location</h3>
      <div class="text-sm text-stone-600 font-mono">
        <p>Ready: <code class="bg-white px-2 py-0.5 rounded">{READY_DIR}</code></p>
      </div>
    </div>
  </div>
</AdminLayout>
